<!doctype html>
<html>
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

<head>
<title>KMB</title>
    <meta name="description" content="Testing">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel = "stylesheet" href = "style.css">
</head>
<script src = "jquery-3.6.1.min.js">  </script>

<body>
    
<div id="Title">Nahrverkehr</div>
<span id="clock">--:--:--</span>

<br><br>
<div class="BusStop">Lo Tsz Tin
<div id="LoTszTin" class="kmb">Lädt...</div>
</div>
<div class="BusStop">EHC Südwärts
    <div id="EHCS" class="kmb">Lädt...</div>
</div>
<div class="BusStop">EHC Nordwärts
    <div id="EHC" class="kmb">Lädt...</div>
</div>



<script> 
const json = '{"result":true, "count":42}';
const obj = JSON.parse(json);
console.log(obj['result']);

var datetimenow = "";
var tablehead = "<table><tr><th>Linie</th><th>Zeit</th><th>Ziel</th><th><span style='font-size:12px'>Abfahrt in</span></th></tr>";

function getTime(){
    var timenow = "";
    $.ajax({
        type: 'GET',
        url:'http://worldtimeapi.org/api/timezone/Asia/Hong_Kong',
        dataType: 'json',
        async : false,
        success: function(data){
            datetimenow = data['datetime'].substring(0,19);
            timenow = data['datetime'].substring(11,19);
            $("#clock").html(timenow);
        }
    });
   
}

function addupRoutes(resp, data, number){
    resp = resp + "<tr><td>" + data['data'][number]['route'] + "</td><td>"+ data['data'][number]['eta'].substring(11,16) + "</td><td><span id='ziel'>" +  data['data'][number]['dest_tc'] + "</span></td>";
    var diff =(new Date(Date.parse(data['data'][number]['eta'])).getTime() - new Date(Date.parse(datetimenow)).getTime()) / 1000;
    diff /= 60;
    if( diff < 1 ){
        resp = resp + "<td></td>";
    }
    else if(Math.round(diff) < 60){
        resp = resp + "<td>" + Math.round(diff) + "<span style='font-size: 10px;'> Min.</span></td>";
    }
    else{
        resp = resp + "<td>" + Math.round(diff/60) + "<span style='font-size: 10px;'>  Std.</span></td>";
    }
    console.log(diff);
    resp = resp + "</tr>"; 
    return resp;
}

function getStop(stopid,routes){
    var response = "";
    $.ajax({
        type: 'GET',
        url:'https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/'+ stopid,
        dataType: 'json',
        async : false,
        success: function(data){
            let j = 1;
            for(var i = 0; i < data['data'].length; i++ ){ 
                if(data['data'][i]['eta']!=null){
                    if(routes){
                            if(routes.includes(data['data'][i]['route'])){
                                response = addupRoutes(response, data, i);
                                j++;
                            }
                    }
                    else{
                        response = addupRoutes(response, data, i);
                        j++;
                    }
                }
            }
        }
    });
    if(response == ""){
        response = "Kein Daten";
    }
    return response;

}
function refresh(){
    document.getElementById("LoTszTin").innerHTML = tablehead + getStop("9AB9D810103D8382") + "</table>";
    document.getElementById("EHCS").innerHTML = tablehead + getStop("9535298A652873DB",["606","613"])+ "</table>";
    document.getElementById("EHC").innerHTML = tablehead + getStop("991E47DBD416B908",["307","680","681","307P"]) + getStop("D678B3364437D16B",["673"]) + "</table>";

}

getTime();
setInterval(getTime,1000);
refresh();
setInterval(refresh,10000);
</script>
</body>
</html>